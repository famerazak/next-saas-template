name: Supervisor Harness

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  supervisor:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      checks: write
      statuses: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install Playwright dependencies
        run: |
          npm install --no-audit --no-fund
          npx playwright install --with-deps chromium

      - name: Prepare artifacts directory
        run: mkdir -p .supervisor-artifacts

      - name: Run Supervisor
        id: run_supervisor
        shell: bash
        run: |
          set -euo pipefail
          python3 -m harness.supervisor run \
            --tasks-file TASKS.md \
            --policy-file harness/supervisor_policy.json \
            --artifacts-dir .supervisor-artifacts \
            --task-source pilot

      - name: Capture summary path
        id: capture_summary
        if: always()
        run: |
          summary_file=$(find .supervisor-artifacts -name summary.md | sort | tail -n1)
          summary_json=$(find .supervisor-artifacts -name summary.json | sort | tail -n1)
          echo "summary_file=$summary_file" >> "$GITHUB_OUTPUT"
          echo "summary_json=$summary_json" >> "$GITHUB_OUTPUT"

      - name: Upload supervisor artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: supervisor-artifacts
          path: .supervisor-artifacts
          if-no-files-found: warn

      - name: Comment PR with supervisor summary
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        env:
          SUMMARY_FILE: ${{ steps.capture_summary.outputs.summary_file }}
        with:
          script: |
            const fs = require('fs');
            const marker = '<!-- supervisor-harness-summary -->';
            const summaryPath = process.env.SUMMARY_FILE;
            let body = `${marker}\nSupervisor run completed, but summary file was not found.`;
            if (summaryPath && fs.existsSync(summaryPath)) {
              const content = fs.readFileSync(summaryPath, 'utf8');
              body = `${marker}\n${content}`;
            }

            const {owner, repo} = context.repo;
            const issue_number = context.issue.number;
            const comments = await github.rest.issues.listComments({owner, repo, issue_number, per_page: 100});
            const existing = comments.data.find(c => c.body && c.body.includes(marker));

            if (existing) {
              await github.rest.issues.updateComment({owner, repo, comment_id: existing.id, body});
            } else {
              await github.rest.issues.createComment({owner, repo, issue_number, body});
            }
