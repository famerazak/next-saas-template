name: Supervisor Harness

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:

jobs:
  supervisor:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      checks: write
      statuses: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Resolve target tasks
        id: resolve_targets
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            changed_ids=$(python3 -m harness.scripts.changed_task_ids \
              --base "${{ github.event.pull_request.base.sha }}" \
              --head "${{ github.event.pull_request.head.sha }}" \
              --tasks-file TASKS.md)
          else
            changed_ids=""
          fi

          pilot_ids=$(python3 - <<'PY'
          import json
          from pathlib import Path
          policy = json.loads(Path("harness/supervisor_policy.json").read_text(encoding="utf-8"))
          print(" ".join(policy.get("pilot", {}).get("include_task_ids", [])))
          PY
          )

          if [[ -n "$changed_ids" ]]; then
            filtered_ids=$(python3 - "$changed_ids" "$pilot_ids" <<'PY'
            import sys
            changed = set(sys.argv[1].split())
            pilot = set(sys.argv[2].split())
            print(" ".join(sorted(changed & pilot)))
            PY
            )
          else
            filtered_ids=""
          fi

          if [[ -n "$filtered_ids" ]]; then
            echo "task_source=ids" >> "$GITHUB_OUTPUT"
            echo "task_ids=$filtered_ids" >> "$GITHUB_OUTPUT"
          else
            echo "task_source=pilot" >> "$GITHUB_OUTPUT"
            echo "task_ids=" >> "$GITHUB_OUTPUT"
          fi

      - name: Run Supervisor
        id: run_supervisor
        shell: bash
        run: |
          if [[ "${{ steps.resolve_targets.outputs.task_source }}" == "ids" ]]; then
            python3 -m harness.supervisor run \
              --tasks-file TASKS.md \
              --policy-file harness/supervisor_policy.json \
              --artifacts-dir .supervisor-artifacts \
              --task-source ids \
              --task-ids ${{ steps.resolve_targets.outputs.task_ids }}
          else
            python3 -m harness.supervisor run \
              --tasks-file TASKS.md \
              --policy-file harness/supervisor_policy.json \
              --artifacts-dir .supervisor-artifacts \
              --task-source pilot
          fi

      - name: Capture summary path
        id: capture_summary
        if: always()
        run: |
          summary_file=$(find .supervisor-artifacts -name summary.md | sort | tail -n1)
          summary_json=$(find .supervisor-artifacts -name summary.json | sort | tail -n1)
          echo "summary_file=$summary_file" >> "$GITHUB_OUTPUT"
          echo "summary_json=$summary_json" >> "$GITHUB_OUTPUT"

      - name: Upload supervisor artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: supervisor-artifacts
          path: .supervisor-artifacts

      - name: Comment PR with supervisor summary
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        env:
          SUMMARY_FILE: ${{ steps.capture_summary.outputs.summary_file }}
        with:
          script: |
            const fs = require('fs');
            const marker = '<!-- supervisor-harness-summary -->';
            const summaryPath = process.env.SUMMARY_FILE;
            let body = `${marker}\nSupervisor run completed, but summary file was not found.`;
            if (summaryPath && fs.existsSync(summaryPath)) {
              const content = fs.readFileSync(summaryPath, 'utf8');
              body = `${marker}\n${content}`;
            }

            const {owner, repo} = context.repo;
            const issue_number = context.issue.number;
            const comments = await github.rest.issues.listComments({owner, repo, issue_number, per_page: 100});
            const existing = comments.data.find(c => c.body && c.body.includes(marker));

            if (existing) {
              await github.rest.issues.updateComment({owner, repo, comment_id: existing.id, body});
            } else {
              await github.rest.issues.createComment({owner, repo, issue_number, body});
            }
